# 多租户系统实施指南

## ✅ 已完成的后端改动

### 1. 模型修改
- ✅ 添加 `admin_user` 字段到 `Lottery` 模型
- ✅ 关联到 Django 内置 `User` 模型

### 2. 认证系统
- ✅ 创建 `auth_views.py` - 登录/登出/注册/当前用户接口
- ✅ 添加认证路由到 `urls.py`

### 3. 权限控制
- ✅ `LotteryViewSet` 添加 `IsAuthenticated` 权限
- ✅ `get_queryset()` 添加数据过滤（只返回当前用户的数据）
- ✅ `perform_create()` 自动设置 `admin_user`

### 4. 配置更新
- ✅ REST Framework 配置 Session 认证
- ✅ CORS 配置允许发送凭证
- ✅ Session 配置（7天有效期）

## 📋 待完成步骤

### 步骤1：创建数据库迁移

```bash
cd tg_choujiang/backend
python manage.py makemigrations
python manage.py migrate
```

### 步骤2：创建管理员账号

```bash
python create_admin.py
```

按提示输入：
- 用户名（如：boss1, boss2...）
- 密码
- 邮箱
- 姓名

**每个老板需要一个独立账号！**

### 步骤3：前端改动（需要手动实现）

#### 3.1 创建登录页面

创建文件：`frontend/src/views/Login.vue`

```vue
<template>
  <div class="login-container">
    <el-card class="login-box">
      <template #header>
        <h2>抽奖管理系统</h2>
      </template>
      
      <el-form :model="form" :rules="rules" ref="formRef">
        <el-form-item prop="username">
          <el-input 
            v-model="form.username" 
            placeholder="用户名"
            prefix-icon="User"
          />
        </el-form-item>
        
        <el-form-item prop="password">
          <el-input 
            v-model="form.password" 
            type="password"
            placeholder="密码"
            prefix-icon="Lock"
            @keyup.enter="handleLogin"
          />
        </el-form-item>
        
        <el-form-item>
          <el-button 
            type="primary" 
            @click="handleLogin"
            :loading="loading"
            style="width: 100%;"
          >
            登录
          </el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script>
import api from '../api'

export default {
  name: 'Login',
  data() {
    return {
      form: {
        username: '',
        password: ''
      },
      rules: {
        username: [
          { required: true, message: '请输入用户名', trigger: 'blur' }
        ],
        password: [
          { required: true, message: '请输入密码', trigger: 'blur' }
        ]
      },
      loading: false
    }
  },
  methods: {
    async handleLogin() {
      try {
        await this.$refs.formRef.validate()
        this.loading = true
        
        const user = await api.login(this.form)
        
        // 存储用户信息
        localStorage.setItem('user', JSON.stringify(user))
        
        this.$message.success('登录成功')
        this.$router.push('/')
      } catch (error) {
        console.error('登录失败:', error)
        this.$message.error('登录失败')
      } finally {
        this.loading = false
      }
    }
  }
}
</script>

<style scoped>
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-box {
  width: 400px;
}

.login-box h2 {
  text-align: center;
  margin: 0;
  color: #303133;
}
</style>
```

#### 3.2 更新 API 文件

在 `frontend/src/api/index.js` 添加认证接口：

```javascript
// 认证相关
login(credentials) {
  return axios.post('/api/auth/login/', credentials, {
    withCredentials: true  // 重要：发送Cookie
  }).then(res => res.data)
},

logout() {
  return axios.post('/api/auth/logout/', {}, {
    withCredentials: true
  }).then(res => res.data)
},

getCurrentUser() {
  return axios.get('/api/auth/me/', {
    withCredentials: true
  }).then(res => res.data)
},

// 所有其他API调用也需要添加 withCredentials: true
// 示例：
getLotteries(page = 1) {
  return axios.get(`/api/lotteries/?page=${page}`, {
    withCredentials: true  // 添加这一行
  }).then(res => res.data)
}
```

#### 3.3 添加路由守卫

在 `frontend/src/router/index.js`:

```javascript
// 路由守卫
router.beforeEach(async (to, from, next) => {
  const publicPages = ['/login']
  const authRequired = !publicPages.includes(to.path)
  
  if (authRequired) {
    try {
      // 验证是否登录
      await api.getCurrentUser()
      next()
    } catch (error) {
      // 未登录，跳转到登录页
      next('/login')
    }
  } else {
    next()
  }
})
```

#### 3.4 添加用户信息显示和退出功能

在导航栏添加：

```vue
<el-dropdown>
  <span class="user-info">
    {{ currentUser.username }} <el-icon><arrow-down /></el-icon>
  </span>
  <template #dropdown>
    <el-dropdown-menu>
      <el-dropdown-item @click="handleLogout">退出登录</el-dropdown-item>
    </el-dropdown-menu>
  </template>
</el-dropdown>

methods: {
  async handleLogout() {
    await api.logout()
    localStorage.removeItem('user')
    this.$router.push('/login')
  }
}
```

### 步骤4：测试多租户功能

1. **创建两个管理员账号**
   ```bash
   # 第一个老板
   python create_admin.py  # boss1/password1
   
   # 第二个老板
   python create_admin.py  # boss2/password2
   ```

2. **测试数据隔离**
   - 用 boss1 登录，创建抽奖A
   - 退出，用 boss2 登录
   - boss2 看不到抽奖A ✅
   - boss2 创建抽奖B
   - boss1 看不到抽奖B ✅

## 🔄 数据迁移（可选）

如果您有现有的抽奖数据，需要分配给管理员：

```python
# 在 Django shell 中执行
python manage.py shell

from lottery.models import Lottery
from django.contrib.auth.models import User

# 获取管理员
admin = User.objects.get(username='boss1')

# 将所有抽奖分配给这个管理员
Lottery.objects.filter(admin_user__isnull=True).update(admin_user=admin)
```

## 📊 系统架构

```
┌─────────────┐     登录      ┌──────────────┐
│  老板1       │──────────────▶│  Django      │
│  boss1       │               │  Session     │
└─────────────┘               └──────────────┘
                                     │
                                     ▼
┌─────────────┐            ┌──────────────────┐
│  老板2       │            │  数据过滤器       │
│  boss2       │            │  admin_user=boss1│
└─────────────┘            └──────────────────┘
                                     │
                                     ▼
                           ┌──────────────────┐
                           │  只返回boss1的   │
                           │  抽奖数据        │
                           └──────────────────┘
```

## ⚠️ 注意事项

1. **生产环境配置**
   - 修改 `SECRET_KEY`
   - 设置 `DEBUG = False`
   - 配置 `ALLOWED_HOSTS`
   - 使用 HTTPS
   - 配置正确的 CORS_ALLOWED_ORIGINS

2. **密码安全**
   - 使用强密码
   - 定期更换密码
   - 考虑添加双因素认证

3. **Session 安全**
   - 生产环境使用 `SESSION_COOKIE_SECURE = True`（需要 HTTPS）
   - 定期清理过期 session

## 🚀 启动系统

```bash
# 后端
cd tg_choujiang/backend
python manage.py runserver

# 前端
cd tg_choujiang/frontend
npm run serve
```

访问 http://localhost:8080/login 登录！
