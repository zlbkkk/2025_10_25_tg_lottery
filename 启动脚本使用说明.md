# 🚀 启动脚本使用说明

## 📋 脚本列表

### Windows 批处理脚本

| 脚本文件 | 用途 | 适用场景 |
|---------|------|----------|
| `START_MULTI_TENANT.bat` | 启动多租户模式 ⭐ | 商业化、多老板使用 |
| `START_ALL.bat` | 启动单机器人模式 | 个人测试、单一使用 |
| `STOP_ALL.bat` | 停止所有服务 | 关闭系统 |

### Linux/Mac Shell 脚本

| 脚本文件 | 用途 | 适用场景 |
|---------|------|----------|
| `start_multi_tenant.sh` | 启动多租户模式 ⭐ | 商业化、多老板使用 |
| `stop_all.sh` | 停止所有服务 | 关闭系统 |

---

## 🎯 推荐使用：多租户模式

### Windows

#### 启动系统

```powershell
# 双击运行即可
START_MULTI_TENANT.bat
```

或在终端运行：

```powershell
cd tg_choujiang
.\START_MULTI_TENANT.bat
```

#### 停止系统

```powershell
# 双击运行即可
STOP_ALL.bat
```

或直接关闭所有打开的命令行窗口。

---

### Linux/Mac

#### 首次使用：添加执行权限

```bash
cd tg_choujiang
chmod +x start_multi_tenant.sh
chmod +x stop_all.sh
```

#### 启动系统

```bash
./start_multi_tenant.sh
```

#### 停止系统

```bash
./stop_all.sh
```

---

## 📊 多租户模式 vs 单机器人模式

### 多租户模式 (`START_MULTI_TENANT.bat`) ⭐ 推荐

**特性：**
- ✅ 支持多个租户同时使用
- ✅ 每个租户配置自己的 Bot Token
- ✅ 热重载：配置后自动启动/重启 Bot
- ✅ 数据完全隔离
- ✅ 运行中可添加/删除租户

**启动的服务：**
1. Django 后端 API
2. Vue 前端管理界面
3. **多租户 Bot** (`multi_tenant_bot.py`) - 热重载
4. 自动开奖守护进程

**适用场景：**
- 🏢 商业化运营
- 👥 多个老板/客户同时使用
- 🔄 需要动态添加/删除用户
- 🚀 生产环境部署

---

### 单机器人模式 (`START_ALL.bat`)

**特性：**
- ✅ 简单直接
- ⚠️ 只支持一个 Bot Token
- ⚠️ 修改 Token 需要重启
- ⚠️ 无数据隔离

**启动的服务：**
1. Django 后端 API
2. Vue 前端管理界面
3. **单一 Bot** (`bot.py`) - 需配置 `config.py`
4. 自动开奖守护进程

**适用场景：**
- 🧪 个人测试
- 👤 单一用户使用
- 📝 开发调试

---

## 🔥 多租户模式详细说明

### 启动流程

```
┌─────────────────────────────────────────┐
│  双击 START_MULTI_TENANT.bat            │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  打开 4 个命令行窗口                     │
│  1. Backend API Server                  │
│  2. Frontend Admin Panel                │
│  3. Multi-Tenant Bot (Hot Reload)       │
│  4. Auto Draw Scheduler                 │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  Bot 程序启动 (等待配置)                │
│  ⚠️  暂无激活的Bot配置                   │
│  📝 请通过后台管理页面配置Bot Token      │
│  🔄 将在 10 秒后重新检查...              │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  访问 http://localhost:8080             │
│  配置 Bot Token                         │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  10秒内 Bot 自动启动！                   │
│  🆕 发现新配置，启动Bot: admin           │
│  ✅ [admin] Bot启动成功！                 │
└─────────────────────────────────────────┘
```

### 窗口说明

#### 窗口 1: Backend API Server

```
后端服务器启动中...
Django version 4.x
Starting development server at http://127.0.0.1:8000/
Quit the server with CTRL-BREAK.
```

**作用：** 提供 API 接口和数据库访问

#### 窗口 2: Frontend Admin Panel

```
前端界面启动中...
VITE v4.x  ready in xxx ms
➜  Local:   http://localhost:8080/
```

**作用：** 提供管理界面

#### 窗口 3: Multi-Tenant Bot (Hot Reload)

```
多租户Bot启动中 (热重载模式)...

💡 提示：Bot会自动监控配置变化
   - 新增配置 → 自动启动Bot
   - 修改Token → 自动重启Bot
   - 禁用配置 → 自动停止Bot

============================================================
🚀 多租户抽奖Bot系统启动中（热重载模式）...
============================================================
⚠️  暂无激活的Bot配置
📝 请通过后台管理页面配置Bot Token
🔄 将在 10 秒后重新检查...
```

**作用：** 管理多个租户的 Bot 进程

#### 窗口 4: Auto Draw Scheduler

```
自动开奖守护进程启动中...
[2024-01-01 10:00:00] 自动开奖守护进程启动
[2024-01-01 10:00:00] 每 60 秒检查一次
```

**作用：** 定时检查并自动开奖

---

## 📝 使用步骤

### 完整流程（首次使用）

#### Step 1: 启动系统

**Windows:**
```powershell
双击 START_MULTI_TENANT.bat
```

**Linux/Mac:**
```bash
./start_multi_tenant.sh
```

#### Step 2: 等待服务启动

- 后端：约 3 秒
- 前端：约 10-30 秒（首次需要编译）
- Bot：立即启动（等待配置）
- 自动开奖：约 2 秒

#### Step 3: 访问管理界面

打开浏览器访问：
```
http://localhost:8080
```

#### Step 4: 登录或注册

- **已有账号：** 直接登录
- **首次使用：** 点击"立即注册"创建账号

#### Step 5: 配置 Bot Token

1. 点击导航栏的 **"Bot配置"**
2. 在 Telegram 搜索 `@BotFather`
3. 发送 `/newbot` 创建 Bot
4. 复制 Token 并粘贴
5. 点击 **"测试连接"** 验证
6. 点击 **"保存配置"**

#### Step 6: 观察 Bot 自动启动

在 "Multi-Tenant Bot" 窗口中，10秒内会看到：

```
🆕 发现新配置，启动Bot: admin (User ID: 1)
✅ [admin] Bot启动成功！
📊 当前运行: 1 个Bot | 下次检查: 10秒后
```

#### Step 7: 开始使用

- 在 Telegram 搜索您的 Bot
- 发送 `/start` 开始使用
- 在后台创建抽奖活动
- 用户参与抽奖

---

## ⚙️ 高级配置

### 修改检查间隔

编辑 `bot/multi_tenant_bot.py`：

```python
# 配置检查间隔（秒）
check_interval = 10  # 默认10秒，可以修改为 5、15、30 等
```

**建议：**
- 开发测试：`5秒` - 快速响应
- 生产环境：`10-30秒` - 平衡性能

### 修改端口

#### 后端端口（默认 8000）

编辑 `START_MULTI_TENANT.bat`：

```batch
python -u manage.py runserver 0.0.0.0:8080 --noreload
```

#### 前端端口（默认 8080）

编辑 `frontend/vite.config.js`：

```javascript
export default defineConfig({
  server: {
    port: 3000  // 修改为其他端口
  }
})
```

---

## 🛑 停止服务

### 方法 1：使用停止脚本（推荐）

**Windows:**
```powershell
双击 STOP_ALL.bat
```

**Linux/Mac:**
```bash
./stop_all.sh
```

### 方法 2：手动关闭窗口

直接关闭所有打开的命令行窗口。

### 方法 3：Ctrl+C（仅当前窗口）

在任意窗口按 `Ctrl+C` 停止该服务。

---

## 📖 日志查看

### Windows

日志在各个命令行窗口中实时显示。

### Linux/Mac

```bash
# 查看后端日志
tail -f logs/backend.log

# 查看前端日志
tail -f logs/frontend.log

# 查看 Bot 日志
tail -f logs/bot.log

# 查看自动开奖日志
tail -f logs/auto_draw.log
```

---

## ⚠️ 常见问题

### Q1: 端口被占用

**错误：** `Error: That port is already in use.`

**解决：**
1. 关闭占用端口的程序
2. 或修改配置使用其他端口

**Windows 查找占用：**
```powershell
netstat -ano | findstr :8080
taskkill /PID <PID> /F
```

**Linux/Mac 查找占用：**
```bash
lsof -i :8080
kill -9 <PID>
```

### Q2: 前端启动慢

**原因：** 首次启动需要 npm 编译

**解决：** 耐心等待 30-60 秒

### Q3: Bot 没有自动启动

**检查：**
1. Bot 窗口是否正常运行
2. 是否已保存 Token 配置
3. "启用状态"开关是否打开
4. 等待至少 10 秒

### Q4: 修改配置不生效

**解决：**
1. 确认已点击"保存配置"
2. 等待 10 秒让热重载生效
3. 查看 Bot 窗口是否有重启日志

---

## 🎉 总结

### 推荐使用

✅ **多租户模式** (`START_MULTI_TENANT.bat`)
- 支持热重载
- 支持多用户
- 生产环境首选

### 快速启动

**Windows:**
```powershell
# 启动
双击 START_MULTI_TENANT.bat

# 停止
双击 STOP_ALL.bat
```

**Linux/Mac:**
```bash
# 启动
./start_multi_tenant.sh

# 停止
./stop_all.sh
```

---

**祝使用愉快！** 🎊

