# 🔥 Bot热重载功能说明

## 🎯 功能概述

Bot程序现在支持**热重载（Hot Reload）**，这意味着：

- ✅ **先启动Bot程序，后配置Token** - 完全OK！
- ✅ **运行中修改Token** - 自动重启对应的Bot
- ✅ **运行中添加新用户** - 自动启动新Bot
- ✅ **运行中禁用Bot** - 自动停止对应的Bot
- ✅ **Bot意外崩溃** - 自动重启

**无需手动重启Bot程序！** 🎉

---

## 🚀 使用演示

### 场景1：先启动Bot，后配置Token

#### 第1步：启动Bot程序（没有任何配置）

```powershell
cd tg_choujiang/bot
python multi_tenant_bot.py
```

**输出：**
```
============================================================
🚀 多租户抽奖Bot系统启动中（热重载模式）...
============================================================
💡 提示：系统会自动监控配置变化
   - 新增配置 → 自动启动Bot
   - 修改Token → 自动重启Bot
   - 禁用配置 → 自动停止Bot
============================================================
⚠️  暂无激活的Bot配置
📝 请通过后台管理页面配置Bot Token
🔄 将在 10 秒后重新检查...
```

**Bot程序会持续运行，等待配置！** ✨

#### 第2步：在后台配置Token

1. 访问 `http://localhost:8080`
2. 登录账号（如：`admin`）
3. 点击 **"Bot配置"**
4. 填写Token并保存

#### 第3步：观察Bot自动启动

**10秒内，终端会自动输出：**
```
🆕 发现新配置，启动Bot: admin (User ID: 1)
✅ [admin] Bot启动成功！
📊 当前运行: 1 个Bot | 下次检查: 10秒后
```

**完全自动，无需重启！** 🎊

---

### 场景2：运行中修改Token

#### 当前状态
```
📊 当前运行: 2 个Bot | 下次检查: 10秒后
  - admin (User ID: 1)
  - boss2 (User ID: 2)
```

#### 操作：修改admin的Token

1. 登录admin账号
2. 进入"Bot配置"
3. 修改Token或Bot用户名
4. 保存

#### 结果：自动检测并重启

**10秒内自动输出：**
```
🔄 重启Bot: admin (User ID: 1) - 配置已更新
🛑 停止旧Bot进程...
✅ 启动新Bot进程...
✅ [admin] Bot启动成功！
📊 当前运行: 2 个Bot | 下次检查: 10秒后
```

**其他Bot不受影响！** 👍

---

### 场景3：运行中添加新租户

#### 操作：新用户注册并配置Bot

1. 新用户注册账号：`boss3`
2. 登录后配置自己的Bot Token
3. 保存

#### 结果：自动启动新Bot

**10秒内自动输出：**
```
🆕 发现新配置，启动Bot: boss3 (User ID: 3)
✅ [boss3] Bot启动成功！
📊 当前运行: 3 个Bot | 下次检查: 10秒后
```

---

### 场景4：运行中禁用Bot

#### 操作：关闭某个Bot

1. 登录boss2账号
2. 进入"Bot配置"
3. 关闭"启用状态"开关
4. 保存

#### 结果：自动停止

**10秒内自动输出：**
```
🛑 停止Bot: User ID 2 (配置已禁用或删除)
📊 当前运行: 2 个Bot | 下次检查: 10秒后
```

---

### 场景5：Bot意外崩溃自动重启

#### 如果某个Bot进程意外退出

**系统自动检测并重启：**
```
⚠️  Bot进程意外退出: admin (User ID: 1)
🔄 重新启动: admin
✅ [admin] Bot启动成功！
📊 当前运行: 2 个Bot | 下次检查: 10秒后
```

---

## ⚙️ 工作原理

### 监控机制

```
┌──────────────────────────────────────────┐
│         主监控进程（持续运行）            │
└──────────────────────────────────────────┘
              ↓ 每10秒检查一次
┌──────────────────────────────────────────┐
│    查询数据库：bot_configs表              │
│    WHERE is_active = True                │
│      AND bot_token IS NOT NULL           │
└──────────────────────────────────────────┘
              ↓ 对比当前运行状态
┌──────────────────────────────────────────┐
│          变化检测                         │
│  ✓ 新配置？   → 启动新Bot进程            │
│  ✓ Token变？  → 重启对应Bot进程          │
│  ✓ 被禁用？   → 停止对应Bot进程          │
│  ✓ 进程死？   → 自动重启                 │
└──────────────────────────────────────────┘
```

### 配置哈希

系统通过计算配置哈希来检测变化：

```python
config_hash = hash(f"{token}_{username}")

# 变化前：hash("123:ABC_@bot1") = 123456789
# 变化后：hash("456:DEF_@bot1") = 987654321
# → 哈希不同，触发重启
```

---

## 📊 完整运行日志示例

```
============================================================
🚀 多租户抽奖Bot系统启动中（热重载模式）...
============================================================
💡 提示：系统会自动监控配置变化
   - 新增配置 → 自动启动Bot
   - 修改Token → 自动重启Bot
   - 禁用配置 → 自动停止Bot
============================================================

⚠️  暂无激活的Bot配置
📝 请通过后台管理页面配置Bot Token
🔄 将在 10 秒后重新检查...

[10秒后]
🆕 发现新配置，启动Bot: admin (User ID: 1)
✅ [admin] Bot启动成功！
📊 当前运行: 1 个Bot | 下次检查: 10秒后

[20秒后]
🆕 发现新配置，启动Bot: boss2 (User ID: 2)
✅ [boss2] Bot启动成功！
📊 当前运行: 2 个Bot | 下次检查: 10秒后

[30秒后 - admin修改了Token]
🔄 重启Bot: admin (User ID: 1) - 配置已更新
✅ [admin] Bot重启成功！
📊 当前运行: 2 个Bot | 下次检查: 10秒后

[40秒后]
📊 当前运行: 2 个Bot | 下次检查: 10秒后

[50秒后 - boss2禁用了Bot]
🛑 停止Bot: User ID 2 (配置已禁用或删除)
📊 当前运行: 1 个Bot | 下次检查: 10秒后

^C [按Ctrl+C]
============================================================
⏹️  收到停止信号，正在关闭所有Bot...
============================================================
🛑 停止 Bot (User ID: 1)
============================================================
👋 所有Bot已停止
============================================================
```

---

## ⚙️ 配置参数

### 检查间隔

在 `multi_tenant_bot.py` 中可以调整检查间隔：

```python
# 配置检查间隔（秒）
check_interval = 10  # 默认10秒，可以修改
```

**建议值：**
- 开发测试：`5秒` - 快速响应
- 生产环境：`10-30秒` - 平衡性能和响应速度

### 进程超时

停止Bot进程的超时时间：

```python
p.join(timeout=5)  # 等待5秒
if p.is_alive():
    p.kill()      # 强制终止
```

---

## 🎯 优势对比

### ❌ 旧版本（无热重载）

```
1. 先配置Token
2. 启动Bot程序
3. 修改Token → 必须手动重启
4. 添加新用户 → 必须手动重启
5. 禁用Bot → 必须手动重启
```

### ✅ 新版本（热重载）

```
1. 可以先启动Bot（等待配置）
2. 配置Token → 自动启动
3. 修改Token → 自动重启
4. 添加新用户 → 自动启动新Bot
5. 禁用Bot → 自动停止
6. 崩溃恢复 → 自动重启
```

---

## 💡 使用建议

### 推荐启动顺序

```powershell
# 1. 启动后端
cd tg_choujiang/backend
python manage.py runserver

# 2. 启动前端
cd tg_choujiang/frontend
npm run dev

# 3. 启动Bot（可以在配置前启动）
cd tg_choujiang/bot
python multi_tenant_bot.py

# 4. 访问后台配置Token
# http://localhost:8080
```

### 生产环境部署

建议使用进程管理工具：

#### Supervisor（Linux）

```ini
[program:multi_tenant_bot]
command=python /path/to/multi_tenant_bot.py
directory=/path/to/bot/
autostart=true
autorestart=true
stderr_logfile=/var/log/bot.err.log
stdout_logfile=/var/log/bot.out.log
```

#### PM2（跨平台）

```bash
pm2 start multi_tenant_bot.py --name lottery-bot --interpreter python3
pm2 save
pm2 startup
```

---

## ⚠️ 注意事项

### 1. 检查间隔延迟

- 配置保存后，最多需要等待 `check_interval` 秒才生效
- 默认10秒，不会立即生效

### 2. 数据库连接

- 确保数据库持续可访问
- 主进程会定期查询数据库

### 3. 进程资源

- 每个Bot占用一个独立进程
- 建议租户数 < 50（Polling模式）

### 4. Token安全

- Token变化会触发重启
- 修改用户名不会影响Token

---

## 🎉 总结

**现在您可以：**

✅ **随时启动Bot程序** - 不管有没有配置
✅ **运行中配置Token** - 自动加载
✅ **运行中修改配置** - 自动重启
✅ **多租户动态管理** - 完全自动化

**完全实现了您的需求！** 🚀

---

**享受热重载带来的便利吧！** 🎊

