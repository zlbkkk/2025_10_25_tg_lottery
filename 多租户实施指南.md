# å¤šç§Ÿæˆ·ç³»ç»Ÿå®æ–½æŒ‡å—

## âœ… å·²å®Œæˆçš„åç«¯æ”¹åŠ¨

### 1. æ¨¡å‹ä¿®æ”¹
- âœ… æ·»åŠ  `admin_user` å­—æ®µåˆ° `Lottery` æ¨¡å‹
- âœ… å…³è”åˆ° Django å†…ç½® `User` æ¨¡å‹

### 2. è®¤è¯ç³»ç»Ÿ
- âœ… åˆ›å»º `auth_views.py` - ç™»å½•/ç™»å‡º/æ³¨å†Œ/å½“å‰ç”¨æˆ·æ¥å£
- âœ… æ·»åŠ è®¤è¯è·¯ç”±åˆ° `urls.py`

### 3. æƒé™æ§åˆ¶
- âœ… `LotteryViewSet` æ·»åŠ  `IsAuthenticated` æƒé™
- âœ… `get_queryset()` æ·»åŠ æ•°æ®è¿‡æ»¤ï¼ˆåªè¿”å›å½“å‰ç”¨æˆ·çš„æ•°æ®ï¼‰
- âœ… `perform_create()` è‡ªåŠ¨è®¾ç½® `admin_user`

### 4. é…ç½®æ›´æ–°
- âœ… REST Framework é…ç½® Session è®¤è¯
- âœ… CORS é…ç½®å…è®¸å‘é€å‡­è¯
- âœ… Session é…ç½®ï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰

## ğŸ“‹ å¾…å®Œæˆæ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºæ•°æ®åº“è¿ç§»

```bash
cd tg_choujiang/backend
python manage.py makemigrations
python manage.py migrate
```

### æ­¥éª¤2ï¼šåˆ›å»ºç®¡ç†å‘˜è´¦å·

```bash
python create_admin.py
```

æŒ‰æç¤ºè¾“å…¥ï¼š
- ç”¨æˆ·åï¼ˆå¦‚ï¼šboss1, boss2...ï¼‰
- å¯†ç 
- é‚®ç®±
- å§“å

**æ¯ä¸ªè€æ¿éœ€è¦ä¸€ä¸ªç‹¬ç«‹è´¦å·ï¼**

### æ­¥éª¤3ï¼šå‰ç«¯æ”¹åŠ¨ï¼ˆéœ€è¦æ‰‹åŠ¨å®ç°ï¼‰

#### 3.1 åˆ›å»ºç™»å½•é¡µé¢

åˆ›å»ºæ–‡ä»¶ï¼š`frontend/src/views/Login.vue`

```vue
<template>
  <div class="login-container">
    <el-card class="login-box">
      <template #header>
        <h2>æŠ½å¥–ç®¡ç†ç³»ç»Ÿ</h2>
      </template>
      
      <el-form :model="form" :rules="rules" ref="formRef">
        <el-form-item prop="username">
          <el-input 
            v-model="form.username" 
            placeholder="ç”¨æˆ·å"
            prefix-icon="User"
          />
        </el-form-item>
        
        <el-form-item prop="password">
          <el-input 
            v-model="form.password" 
            type="password"
            placeholder="å¯†ç "
            prefix-icon="Lock"
            @keyup.enter="handleLogin"
          />
        </el-form-item>
        
        <el-form-item>
          <el-button 
            type="primary" 
            @click="handleLogin"
            :loading="loading"
            style="width: 100%;"
          >
            ç™»å½•
          </el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script>
import api from '../api'

export default {
  name: 'Login',
  data() {
    return {
      form: {
        username: '',
        password: ''
      },
      rules: {
        username: [
          { required: true, message: 'è¯·è¾“å…¥ç”¨æˆ·å', trigger: 'blur' }
        ],
        password: [
          { required: true, message: 'è¯·è¾“å…¥å¯†ç ', trigger: 'blur' }
        ]
      },
      loading: false
    }
  },
  methods: {
    async handleLogin() {
      try {
        await this.$refs.formRef.validate()
        this.loading = true
        
        const user = await api.login(this.form)
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        localStorage.setItem('user', JSON.stringify(user))
        
        this.$message.success('ç™»å½•æˆåŠŸ')
        this.$router.push('/')
      } catch (error) {
        console.error('ç™»å½•å¤±è´¥:', error)
        this.$message.error('ç™»å½•å¤±è´¥')
      } finally {
        this.loading = false
      }
    }
  }
}
</script>

<style scoped>
.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-box {
  width: 400px;
}

.login-box h2 {
  text-align: center;
  margin: 0;
  color: #303133;
}
</style>
```

#### 3.2 æ›´æ–° API æ–‡ä»¶

åœ¨ `frontend/src/api/index.js` æ·»åŠ è®¤è¯æ¥å£ï¼š

```javascript
// è®¤è¯ç›¸å…³
login(credentials) {
  return axios.post('/api/auth/login/', credentials, {
    withCredentials: true  // é‡è¦ï¼šå‘é€Cookie
  }).then(res => res.data)
},

logout() {
  return axios.post('/api/auth/logout/', {}, {
    withCredentials: true
  }).then(res => res.data)
},

getCurrentUser() {
  return axios.get('/api/auth/me/', {
    withCredentials: true
  }).then(res => res.data)
},

// æ‰€æœ‰å…¶ä»–APIè°ƒç”¨ä¹Ÿéœ€è¦æ·»åŠ  withCredentials: true
// ç¤ºä¾‹ï¼š
getLotteries(page = 1) {
  return axios.get(`/api/lotteries/?page=${page}`, {
    withCredentials: true  // æ·»åŠ è¿™ä¸€è¡Œ
  }).then(res => res.data)
}
```

#### 3.3 æ·»åŠ è·¯ç”±å®ˆå«

åœ¨ `frontend/src/router/index.js`:

```javascript
// è·¯ç”±å®ˆå«
router.beforeEach(async (to, from, next) => {
  const publicPages = ['/login']
  const authRequired = !publicPages.includes(to.path)
  
  if (authRequired) {
    try {
      // éªŒè¯æ˜¯å¦ç™»å½•
      await api.getCurrentUser()
      next()
    } catch (error) {
      // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      next('/login')
    }
  } else {
    next()
  }
})
```

#### 3.4 æ·»åŠ ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºå’Œé€€å‡ºåŠŸèƒ½

åœ¨å¯¼èˆªæ æ·»åŠ ï¼š

```vue
<el-dropdown>
  <span class="user-info">
    {{ currentUser.username }} <el-icon><arrow-down /></el-icon>
  </span>
  <template #dropdown>
    <el-dropdown-menu>
      <el-dropdown-item @click="handleLogout">é€€å‡ºç™»å½•</el-dropdown-item>
    </el-dropdown-menu>
  </template>
</el-dropdown>

methods: {
  async handleLogout() {
    await api.logout()
    localStorage.removeItem('user')
    this.$router.push('/login')
  }
}
```

### æ­¥éª¤4ï¼šæµ‹è¯•å¤šç§Ÿæˆ·åŠŸèƒ½

1. **åˆ›å»ºä¸¤ä¸ªç®¡ç†å‘˜è´¦å·**
   ```bash
   # ç¬¬ä¸€ä¸ªè€æ¿
   python create_admin.py  # boss1/password1
   
   # ç¬¬äºŒä¸ªè€æ¿
   python create_admin.py  # boss2/password2
   ```

2. **æµ‹è¯•æ•°æ®éš”ç¦»**
   - ç”¨ boss1 ç™»å½•ï¼Œåˆ›å»ºæŠ½å¥–A
   - é€€å‡ºï¼Œç”¨ boss2 ç™»å½•
   - boss2 çœ‹ä¸åˆ°æŠ½å¥–A âœ…
   - boss2 åˆ›å»ºæŠ½å¥–B
   - boss1 çœ‹ä¸åˆ°æŠ½å¥–B âœ…

## ğŸ”„ æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æœ‰ç°æœ‰çš„æŠ½å¥–æ•°æ®ï¼Œéœ€è¦åˆ†é…ç»™ç®¡ç†å‘˜ï¼š

```python
# åœ¨ Django shell ä¸­æ‰§è¡Œ
python manage.py shell

from lottery.models import Lottery
from django.contrib.auth.models import User

# è·å–ç®¡ç†å‘˜
admin = User.objects.get(username='boss1')

# å°†æ‰€æœ‰æŠ½å¥–åˆ†é…ç»™è¿™ä¸ªç®¡ç†å‘˜
Lottery.objects.filter(admin_user__isnull=True).update(admin_user=admin)
```

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ç™»å½•      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è€æ¿1       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Django      â”‚
â”‚  boss1       â”‚               â”‚  Session     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è€æ¿2       â”‚            â”‚  æ•°æ®è¿‡æ»¤å™¨       â”‚
â”‚  boss2       â”‚            â”‚  admin_user=boss1â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  åªè¿”å›boss1çš„   â”‚
                           â”‚  æŠ½å¥–æ•°æ®        â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - ä¿®æ”¹ `SECRET_KEY`
   - è®¾ç½® `DEBUG = False`
   - é…ç½® `ALLOWED_HOSTS`
   - ä½¿ç”¨ HTTPS
   - é…ç½®æ­£ç¡®çš„ CORS_ALLOWED_ORIGINS

2. **å¯†ç å®‰å…¨**
   - ä½¿ç”¨å¼ºå¯†ç 
   - å®šæœŸæ›´æ¢å¯†ç 
   - è€ƒè™‘æ·»åŠ åŒå› ç´ è®¤è¯

3. **Session å®‰å…¨**
   - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `SESSION_COOKIE_SECURE = True`ï¼ˆéœ€è¦ HTTPSï¼‰
   - å®šæœŸæ¸…ç†è¿‡æœŸ session

## ğŸš€ å¯åŠ¨ç³»ç»Ÿ

```bash
# åç«¯
cd tg_choujiang/backend
python manage.py runserver

# å‰ç«¯
cd tg_choujiang/frontend
npm run serve
```

è®¿é—® http://localhost:8080/login ç™»å½•ï¼
